package script.contactlab.com;

import java.io.BufferedReader;
import java.io.File;
import java.io.InputStreamReader;
import java.util.HashMap;
import java.util.List;

import org.apache.commons.lang3.StringUtils;

import com.google.common.collect.Lists;
import com.google.common.collect.Maps;

public class SearchLoadDataRealFileName {

	public static final String END_LOADDATA_STATEMENT = " INTO TABLE";
	public static final String START_LOADDATA_STATEMENT = "LOAD DATA LOCAL INFILE ";

	public HashMap<Integer, String[]> run(List<Integer> intersection, String binaryLogDirPath) throws Exception {
		final HashMap<Integer, String[]> result = Maps.newHashMap();
		
		for (Integer id : intersection) {
			final String[] cmd = {"/bin/sh", "-c", "grep -r -A5 'Execute_load_query[[:space:]]thread_id=" + id + "' " + binaryLogDirPath};		
			
			final Process p = Runtime.getRuntime().exec(cmd);
		    p.waitFor();
		 
		    final BufferedReader reader = new BufferedReader(new InputStreamReader(p.getInputStream()));		    
		    final List<String> fileNames = Lists.newArrayList();
		    
		    String line = "";			
		    while ((line = reader.readLine())!= null) {
		    	final String s = StringUtils.strip(line);
		    	final String[] between = StringUtils.substringsBetween(s, START_LOADDATA_STATEMENT, END_LOADDATA_STATEMENT);		    			    	
		    	
		    	if (between != null) {
		    		fileNames.add(new File(StringUtils.substringBetween(between[0], "'")).getName());
		    	}		    	
		    }		
		    
		    if (!fileNames.isEmpty()) {
		    	result.put(id, fileNames.toArray(new String[]{}));	
		    }
		}		
	    
	    return result;
	}

//	public static void main(String[] args) throws Exception {
//		HashMap<Integer, String[]> run = new SearchLoadDataRealFileName().run(Lists.newArrayList(776569920), "/media/alan/DATA/6/bin");
//
//		for (Entry<Integer, String[]> e : run.entrySet()) {
//			System.err.println(e.getKey() + " = " + Arrays.toString(e.getValue()));
//		}
//	}
	
}
